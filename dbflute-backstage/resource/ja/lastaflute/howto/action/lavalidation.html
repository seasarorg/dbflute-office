<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja" >
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta http-equiv="Content-Style-Type" content="text/css" />
	<meta name="keywords" content="DBFlute,LastaFlute,Java,Lean Startup,Incremental Development" />
	<style type="text/css" title="currentStyle">@import "../../../../css/sub.css";</style>
	<title>LastaFlute Validation | LastaFlute</title>
</head>
<body>
<div id="container" class="ct-manual">
<div id="mainbar"><div id="header">
	<a href="#">DBFlute<span>DB変更に強いO/Rマッパー</span></a>
	<img src="../../../../image/logo-content.gif" alt="logo"/>
	<ul>
		<li class="hd-introduction"><a href="#">Introduction</a></li>
		<li class="hd-tutorial"><a href="#">Tutorial</a></li>
		<li><ul><li class="hd-architect"><a href="#">for Architect</a></li><li class="hd-developer"><a href="#">for Developer</a></li></ul></li>
		<li class="hd-environment"><a href="#">Environment</a></li>
		<li><ul><li class="hd-install"><a href="#">Install</a></li><li class="hd-upgrade"><a href="#">Upgrade</a></li></ul></li>
		<li class="hd-manual"><a href="#">Manual</a></li>
	</ul>
</div>

<div id="content"><!-- __content-start__ -->
	<h1>LastaFlute Validation</h1>
	<div class="relatedpage"><a href="../../index.html">LastaFlute</a></div>
	${indexlist}

	<h2 id="howto">Validationの実装方法</h2>
	<p>
		<em class="keyword">アノテーションを付けて、validate() を呼びます。</em>
	</p>

	<h2 id="formannotation">1. Form,Bodyにアノテーション</h2>
	<h3 id="hibernate">Hibernate Validator</h3>
	<p>
		Form, Body クラスに、Hibernate Validator のアノテーションを付けます。
	</p>
	<div class="detailpage"><a href="http://hibernate.org/validator/">Hibernate Validator | Hibernate</a></div>
<pre><span class="codetitle">e.g. Form class @Java</span><code>
<span class="keyword">public class</span> SeaLandForm {

    <span class="point">@Length(max = 10)</span>
    <span class="keyword">public</span> String <span class="attribute">memberName</span>;
}
</code></pre>
	<h3 id="required">必須チェックは @Required</h3>
	<p>
		必須チェックに関しては、LastaFlute で Required アノテーションを用意しています。
		String や Integer など型を意識せずに利用できるアノテーションです。
		<span class="frm">(StringだからNotEmpty, IntegerだからNotNullなどと型ごとに使い分けなくてもいいように)</span>
	</p>
<pre><span class="codetitle">e.g. Form class @Java</span><code>
<span class="keyword">public class</span> SeaLandForm {

    <span class="point">@Required</span>
    @Length(max = 10)
    <span class="keyword">public</span> String <span class="attribute">memberName</span>;
}
</code></pre>
	<p>
		ルールは以下の通り。<em class="keyword">List や配列の場合は、一件以上というチェックになります。</em>
	</p>
	<dl class="shortkeymainlist">
		<dt>String</dt><dd>NotBlank と同じ</dd>
		<dt>Integer など</dt><dd>NotNull と同じ</dd>
		<dt>LocalDate など</dt><dd>NotNull と同じ</dd>
		<dt>List や Map など</dt><dd>一件以上</dd>
	</dl>
	<h3 id="validnested">ネストのプロパティは @Valid</h3>
	<p>
		<em class="keyword">ネストしているクラスの中のアノテーションも有効にしたいときは、@Valid を付けます</em>
	</p>
<pre><span class="codetitle">e.g. how to validate nested class @Java</span><code>
<span class="keyword">public class</span> SeaLandForm {

    <span class="point">@Valid</span>
    <span class="keyword">public</span> PiariElement <span class="attribute">piari</span>;

    <span class="keyword">public static class</span> PiariElement {

        <span class="subpoint">@Required</span>
        <span class="keyword">public</span> String <span class="attribute">dstore</span>;
    }
}
</code></pre>
	<p>
		ちなみに、再利用しないネストクラスは、Form や Body のインナークラスで実装するのをオススメしています。
		戻りの JSON Bean も同じく。
	</p>

	<h2 id="validatemethod">2. Action で validate() を呼ぶ</h2>
	<p>
		Actionクラスで <em class="mark">validate()</em>
		メソッドを呼ぶと、アノテーションの通りにバリデーションされます。
	</p>
<pre><span class="codetitle">e.g. validate() in Action class @Java</span><code>
@Execute
<span class="keyword">public</span> HtmlResponse index(<span class="keyword">int</span> <span class="localvar">productId</span>, SeaLandForm <span class="localvar">form</span>) {
    <span class="point">validate</span>(<span class="localvar">form</span>, <span class="localvar">messages</span> -&gt; {}, () -&gt; {
        <span class="keyword">return</span> asHtml(<span class="attribute">path_Sea_SeaLandJsp</span>);
    });
    <span class="abbreviation">...</span>
    <span class="keyword">return</span> asHtml(<span class="attribute">path_Sea_SeaLandJsp</span>); 
}
</code></pre>
	<dl class="shoshortkeymainlist">
		<dt>第一引数</dt><dd>アノテーションが付与されている Form もしくは Body</dd>
		<dt>第二引数</dt><dd>アノテーションではできないバリデーションを実装 <span class="frm">(後述)</span></dd>
		<dt>第三引数</dt><dd>バリデーションエラーになったときのResponse処理 <span class="frm">(いまの画面に戻すことがほとんど)</span></dd>
	</dl>
	<h3 id="validateapi">JsonResponse なら validateApi()</h3>
	<p>
		JsonResponseの場合は、<em class="mark">validateApi()</em> の方を使います。
		こちらは第三引数がなく、バリデーションエラーは ApiFailureHook#handleValidationError() で、統一的なResponse処理がされます。
	</p>
	<h3 id="switchtoapi">そもそも全部 JsonResponse なら</h3>
	<p>
		もし、JSON APIサーバーで全部 JsonResponse というときは、BaseAction が implements しているインターフェースを LaValidatableApi
		に変更すると、validate() 自体が JsonResponse 用のメソッドになります。<span class="frm">(これは一番最初に決めましょう)</span>
	</p>

	<h2 id="morevalidate">3. Lambdaで、もっとValidation</h2>
	<p>
		アノテーションではできないようなバリデーション <span class="frm">(相関バリデーション、DB検索が必要なバリデーション)</span> をする場合は、第二引数の Lambda で実装します。
		そのとき、メッセージは messages のタイプセーフな add メソッドを使って指定します。
	</p>
<pre><span class="codetitle">e.g. more validation in Lambda @Java</span><code>
@Execute
<span class="keyword">public</span> HtmlResponse index(<span class="keyword">int</span> <span class="localvar">productId</span>, SeaLandForm <span class="localvar">form</span>) {
    <span class="subpoint">validate</span>(<span class="localvar">form</span>, <span class="localvar">messages</span> -&gt; {
        <span class="keyword">if</span> (<span class="localvar">form</span>.<span class="attribute">sea</span> &gt; <span class="localvar">form</span>.<span class="attribute">land</span>) {
            <span class="localvar">messages</span>.<span class="point">addErrorsSeaLand</span>(<span class="literal">"sea"</span>);
        }
    }, () -&gt; {
        <span class="keyword">return</span> asHtml(<span class="attribute">path_Sea_SeaLandJsp</span>);
    });
    <span class="abbreviation">...</span>
}
</code></pre>
	<p>
		ちょっとせまっくるしいので、moreValidate()メソッドに出すとよいでしょう。
	</p>
<pre><span class="codetitle">e.g. moreValidate() @Java</span><code>
@Execute
<span class="keyword">public</span> HtmlResponse index(<span class="keyword">int</span> <span class="localvar">productId</span>, SeaLandForm <span class="localvar">form</span>) {
    <span class="subpoint">validate</span>(<span class="localvar">form</span>, <span class="localvar">messages</span> -&gt; {
        <span class="point">moreValidate</span>(<span class="localvar">form</span>, <span class="localvar">messages</span>);
    }, () -&gt; {
        <span class="keyword">return</span> asHtml(<span class="attribute">path_Sea_SeaLandJsp</span>);
    });
    <span class="abbreviation">...</span>
}

<span class="keyword">public void</span> <span class="subpoint">moreValidate</span>(SeaLandForm <span class="localvar">form</span>, HarborMessages <span class="localvar">messages</span>) {
    <span class="keyword">if</span> (isNotEmpty(<span class="localvar">form</span>.<span class="attribute">sea</span>) != null && isNotEmpty(<span class="localvar">form</span>.<span class="attribute">land</span>)) {
        <span class="keyword">if</span> (<span class="localvar">form</span>.<span class="attribute">sea</span>.length() &gt; <span class="localvar">form</span>.<span class="attribute">land</span>.length()) { <span class="comment">// should be longer</span>
            <span class="localvar">messages</span>.addErrorsSeaLand(<span class="literal">"sea"</span>);
        }
    }
}
</code></pre>
	<p>
		アノテーションの方でバリデーションエラーが発生しても、必ず呼び出されます。
	</p>
	<p>
		必須項目でも、必須チェックに引っかかって null かもしれないので、<em class="keyword">実際に値が入っていたら</em>、という分岐を入れましょう。
	</p>

	<h2 id="jsonvalidation">番外. JSON Bean のバリデーション</h2>
	<p>
		asJson() の引数に指定する JSON Bean にも、アノテーションを付けることができます。 
	</p>
	<p>
		付けておくと、単なるサーバー側のバグチェックだけでなく、LastaDoc にアノテーションが表示されるので、
		フロント側のディベロッパーに項目の特性を自然と伝えることができます。
	</p>
	<p>
		TODO jflute
	</p>
<!-- __content-end__ --></div></div>

<div id="sidebar">
	<ul>
		<li><a href="#">inu</a></li>
		<li><a href="#">neko</a></li>
	</ul>
</div>
<div id="footer">
	<ul>
		<li><a href="#">SiteMap</a></li>
		<li><a href="https://www.seasar.org/issues/browse/DBFLUTE">BTS</a></li>
		<li><a href="http://d.hatena.ne.jp/jflute">Author's Blog</a></li>
	</ul>
</div>
</div>
</body>
</html>